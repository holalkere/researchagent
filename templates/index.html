<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reflective Research Agents with Tools Use</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .step-header { cursor: pointer; }
    .step-running { background-color: #fff3cd; }
    .step-done { background-color: #d1e7dd; }
    .step-error { background-color: #f8d7da; }
    .step-pending { background-color: #e2e3e5; }
    .substep { font-size: 0.95em; margin-left: 1.5rem; }
    .substep-header { cursor: pointer; font-weight: bold; }
    .status-icon { margin-right: 0.5rem; }
    #stepStatusList div { margin-bottom: 0.25rem; }
    #finalReport { background-color: #fff; border: 1px solid #ccc; padding: 1rem; border-radius: 5px; }
  </style>
</head>
<body class="p-4">
<div class="container">
  <h2 class="mb-4">Reflective Research Agent ‚Äî Planning and Tool Use</h2>



  <!-- Prompt area con textarea de 4 l√≠neas -->
  <div class="mb-3">
    <label for="promptInput" class="form-label">Prompt</label>
    <div class="d-flex align-items-start gap-2">
      <textarea
        class="form-control"
        id="promptInput"
        rows="4"
        placeholder="Describe your research topic here"
        style="flex: 1"
      ></textarea>
      <button class="btn btn-primary" onclick="submitPrompt()">Submit</button>
    </div>
    <div class="form-text">Tip: Add 3‚Äì4 details to make your question more specific.</div>
  </div>

  <div id="taskInfo" class="mb-3"></div>
  <div id="stepStatusList" class="mb-4"></div>
  <div id="stepDetails"></div>
  <div id="finalOutput" class="mt-4"></div>
</div>

<script>
let currentTaskId = null;
let currentTopic = null;
let pollInterval = null;
let finalReportMarkdown = "";
const renderedSteps = new Map();

function setTaskInfoGenerating(topic){
  document.getElementById('taskInfo').innerHTML = `
    <h5 class="d-flex align-items-center">
      <span class="me-2">Generating steps for the search: <code>${topic}</code></span>
      <span id="stepsIcon"><span class='spinner-border spinner-border-sm text-primary'></span></span>
    </h5>
  `;
}

function setStepsGenerated(){
  const stepsIcon = document.getElementById('stepsIcon');
  if (stepsIcon) stepsIcon.textContent = '‚úÖ';
}

function disableUI(disabled){
  const btn = document.querySelector('button.btn.btn-primary');
  const input = document.getElementById('promptInput');
  if (btn) btn.disabled = disabled;
  if (input) input.disabled = disabled;
}

function submitPrompt() {
  const prompt = document.getElementById('promptInput').value;
  if (!prompt) return;

  currentTopic = prompt;
  setTaskInfoGenerating(currentTopic);
  disableUI(true);

  fetch('/generate_report', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  })
  .then(res => res.json())
  .then(data => {
    currentTaskId = data.task_id;

    document.getElementById('stepStatusList').innerHTML = '';
    document.getElementById('stepDetails').innerHTML = '';
    document.getElementById('finalOutput').innerHTML = '';
    renderedSteps.clear();

    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(fetchProgress, 2000);
  })
  .catch(() => {
    const statusIcon = document.getElementById('statusIcon');
    if (statusIcon) statusIcon.textContent = '‚ùå';
    disableUI(false);
  });
}

function fetchProgress() {
  if (!currentTaskId) return;

  fetch(`/task_progress/${currentTaskId}`)
    .then(res => res.json())
    .then(data => {
      const { steps } = data;

      if (Array.isArray(steps) && steps.length > 0) {
        setStepsGenerated();
      }

      steps.forEach((step, index) => {
        const stepKey = `${step.title}-${step.status}-${step.substeps.length}`;
        if (renderedSteps.get(index) === stepKey) return;

        renderedSteps.set(index, stepKey);

        const icon = step.status === 'done' ? '‚úÖ' :
                     step.status === 'running' ? '<span class="spinner-border spinner-border-sm text-warning"></span>' :
                     step.status === 'error' ? '‚ùå' : 'üïì';

        const rowId = `step-row-${index}`;
        let row = document.getElementById(rowId);
        if (!row) {
          row = document.createElement('div');
          row.id = rowId;
          row.className = `step-header ${getStatusClass(step.status)}`;
          row.innerHTML = `${icon} ${step.title}`;
          document.getElementById('stepStatusList').appendChild(row);
        } else {
          row.className = `step-header ${getStatusClass(step.status)}`;
          row.innerHTML = `${icon} ${step.title}`;
        }

        const cardId = `step-card-${index}`;
        let card = document.getElementById(cardId);
        const substepsHTML = step.substeps.map((sub, j) => `
          <div class="substep">
            <div class="substep-header" data-bs-toggle="collapse" data-bs-target="#substep-${index}-${j}" aria-expanded="false" aria-controls="substep-${index}-${j}">
              ‚ûï ${sub.title}
            </div>
            <div id="substep-${index}-${j}" class="collapse">
              <div class="bg-light p-2 rounded" style="white-space:pre-wrap;">${marked.parse(sub.content)}</div>
            </div>
          </div>
        `).join('');

        if (!card) {
          card = document.createElement('div');
          card.id = cardId;
          card.className = `card mb-3 ${getStepClass(step.status)}`;
          card.innerHTML = `
            <div class="card-header">${step.title} ‚Äî ${step.status.toUpperCase()}</div>
            <div class="card-body">
              <p>${step.description}</p>
              ${substepsHTML}
            </div>
          `;
          document.getElementById('stepDetails').appendChild(card);
        } else {
          card.className = `card mb-3 ${getStepClass(step.status)}`;
          card.querySelector('.card-header').textContent = `${step.title} ‚Äî ${step.status.toUpperCase()}`;
          card.querySelector('.card-body').innerHTML = `
            <p>${step.description}</p>
            ${substepsHTML}
          `;
        }
      });

      fetchTaskStatus();
    })
    .catch(() => {
      // silent
    });
}

function fetchTaskStatus() {
  fetch(`/task_status/${currentTaskId}`)
    .then(res => res.json())
    .then(task => {
      const statusIcon = document.getElementById('statusIcon');

      if (task.status === 'done') {
        if (statusIcon) statusIcon.textContent = '‚úÖ';
        clearInterval(pollInterval);
        disableUI(false);
      } else if (task.status === 'error') {
        if (statusIcon) statusIcon.textContent = '‚ùå';
        clearInterval(pollInterval);
        disableUI(false);
      }

      if (typeof task.result === 'string') {
        try { task.result = JSON.parse(task.result); } catch { return; }
      }

      if (task.status === 'done' && task.result?.html_report) {
        finalReportMarkdown = task.result.html_report;
        document.getElementById('finalOutput').innerHTML = `
          <h4>Final Report</h4>
          <div class="mb-2">
            <button class="btn btn-outline-secondary btn-sm me-2" onclick="downloadMarkdown()">Download .md</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="downloadHTML()">Download .html</button>
          </div>
          <div id="finalReport">${marked.parse(finalReportMarkdown)}</div>
        `;
      }
    });
}

function getStatusClass(status) {
  return status === 'done' ? 'text-success' :
         status === 'running' ? 'text-warning' :
         status === 'error' ? 'text-danger' : 'text-muted';
}

function getStepClass(status) {
  return status === 'done' ? 'step-done' :
         status === 'running' ? 'step-running' :
         status === 'error' ? 'step-error' : 'step-pending';
}

function downloadMarkdown() {
  const blob = new Blob([finalReportMarkdown], { type: 'text/markdown' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `final_report_${currentTaskId}.md`;
  link.click();
}

function downloadHTML() {
  const htmlContent = marked.parse(finalReportMarkdown);
  const blob = new Blob([htmlContent], { type: 'text/html' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `final_report_${currentTaskId}.html`;
  link.click();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
